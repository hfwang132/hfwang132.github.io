---
title: "SPI 四线模式"
date: 2023-06-29T11:33:45+08:00
draft: true
categories: ["EECS"]
tags: ["硬件协议"]
---

最近被一个 SPI 的问题给卡住了。背景是 AD9361 芯片：

> - AD9361 的 SPI 指令为两个字节，格式为：
> |D15|D14|D13|D12|D11|D10|D9:D0|
> | - | - | - | - | - | - |  -  |
> |W/R|NB2|NB1|NB0| X | X |A[9:0]|
> 
>   其中 
>   - W/R 代表写还是读（1为写，0为读）；
>   - NB2:NB0 代表读写的字节数；
>   - A[9:0] 代表寄存器地址。
>   在发送（写）数据的情况下，要发送的数据要跟在上述两字节的指令之后；在接收（读）数据的情况下，发送指令之后即可开始读取数据。
> - AD9361 的地址为 `0x037` 的寄存器中存储了 `PRODUCT_ID`。对于 AD9361 Rev 2，`PRODUCT_ID`  应当为 `0x0A`。
> - 初始化 AD9361 时，驱动先通过 `GPIO_RESETB` 进行硬件复位（至少 1us），再读取 `0x037` 寄存器，判断 `PRODUCT_ID`。
用 ILA 看波形，MOSI 上正常发送了数据 `[0x00 0x37]`（也就是读 `PRODUCT_ID` 寄存器），但是 MISO 并没有返回 `0x0A`。

为了排除软件原因，于是给 SPI 写了裸核程序（之前用的是 Linux 的 SPI 驱动）。
