<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>HW &amp; SW design of the AXI Quad SPI IP core - Haifei&#39;s Home</title><meta name="Description" content="Haifei&#39;s Home"><meta property="og:title" content="HW &amp; SW design of the AXI Quad SPI IP core" />
<meta property="og:description" content="1 Basics SPI has three-wire mode and four-wire mode. The three-wire mode consists of three wires - SS (Slave Select), SCK (SPI Clock), and MOSI (Master-In-Slave-Out). The four wire mode has an extra line called MISO (Master-In-Slave-Out).
Signals Full Name SS Slave Select SCK SPI Clock MOSI Master-Out-Slave-In MISO Master-In-Slave-Out SPI clock has four modes: CPOL=0/1 and CPHA=0/1. CPOL stands for clock polarity &ndash; clock low or high when in idle." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.com/spi/" /><meta property="og:image" content="http://example.com/logo.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-01T17:49:31+08:00" />
<meta property="article:modified_time" content="2023-07-01T17:49:31+08:00" /><meta property="og:site_name" content="Haifei&#39;s Home" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://example.com/logo.png" /><meta name="twitter:title" content="HW &amp; SW design of the AXI Quad SPI IP core"/>
<meta name="twitter:description" content="1 Basics SPI has three-wire mode and four-wire mode. The three-wire mode consists of three wires - SS (Slave Select), SCK (SPI Clock), and MOSI (Master-In-Slave-Out). The four wire mode has an extra line called MISO (Master-In-Slave-Out).
Signals Full Name SS Slave Select SCK SPI Clock MOSI Master-Out-Slave-In MISO Master-In-Slave-Out SPI clock has four modes: CPOL=0/1 and CPHA=0/1. CPOL stands for clock polarity &ndash; clock low or high when in idle."/>
<meta name="application-name" content="Haifei&#39;s Home">
<meta name="apple-mobile-web-app-title" content="Haifei&#39;s Home"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.com/spi/" /><link rel="prev" href="http://example.com/ui_poll/" /><link rel="next" href="http://example.com/side_proj/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "HW \u0026 SW design of the AXI Quad SPI IP core",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.com\/spi\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "http:\/\/example.com\/images\/Apple-Devices-Preview.png",
                            "width":  3200 ,
                            "height":  2048 
                        }],"genre": "posts","keywords": "SPI, Embedded Systems","wordcount":  1110 ,
        "url": "http:\/\/example.com\/spi\/","datePublished": "2023-07-01T17:49:31+08:00","dateModified": "2023-07-01T17:49:31+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "http:\/\/example.com\/images\/avatar.png",
                    "width":  1400 ,
                    "height":  1400 
                }},"author": {
                "@type": "Person",
                "name": "hfwang132"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Haifei&#39;s Home"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw' aria-hidden='true'></i></span>Haifei&#39;s Home</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/cv/"> CV </a><a class="menu-item" href="/publication/"> Publication </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a><a href="javascript:void(0);" class="menu-item language" title="Select Language">
                    <i class="fa fa-globe" aria-hidden="true"></i>                      
                    <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/spi/" selected>English</option><option value="/zh-cn/spi/">简体中文</option></select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Haifei&#39;s Home"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw' aria-hidden='true'></i></span>Haifei&#39;s Home</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/cv/" title="">CV</a><a class="menu-item" href="/publication/" title="">Publication</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">
                    <i class="fa fa-globe fa-fw" aria-hidden="true"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/spi/" selected>English</option><option value="/zh-cn/spi/">简体中文</option></select>
                </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <meta name="referrer" content="no-referrer-when-downgrade">

<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">HW & SW design of the AXI Quad SPI IP core</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="../../about" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>hfwang132</a></span>&nbsp;<span class="post-category">included in <a href="/categories/eecs/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>EECS</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-07-01">2023-07-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1110 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;6 minutes&nbsp;<span id="/spi/" class="leancloud_visitors" data-flag-title="HW &amp; SW design of the AXI Quad SPI IP core">
                        <i class="far fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-basics">1 Basics</a></li>
        <li><a href="#2-axi-quad-spi-ip-core">2 AXI Quad SPI IP Core</a></li>
        <li><a href="#3-bare-metal-programming">3 Bare-Metal Programming</a></li>
        <li><a href="#4-linux-programming">4 Linux Programming</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h3 id="1-basics">1 Basics</h3>
<p>SPI has three-wire mode and four-wire mode. The three-wire mode consists of three wires - <code>SS</code> (Slave Select), <code>SCK</code> (SPI Clock), and <code>MOSI</code> (Master-In-Slave-Out). The four wire mode has an extra line called <code>MISO</code> (Master-In-Slave-Out).</p>
<table>
<thead>
<tr>
<th>Signals</th>
<th>Full Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>SS</td>
<td>Slave Select</td>
</tr>
<tr>
<td>SCK</td>
<td>SPI Clock</td>
</tr>
<tr>
<td>MOSI</td>
<td>Master-Out-Slave-In</td>
</tr>
<tr>
<td>MISO</td>
<td>Master-In-Slave-Out</td>
</tr>
</tbody>
</table>
<p>SPI clock has four modes: CPOL=0/1 and CPHA=0/1. CPOL stands for clock polarity &ndash; clock low or high when in idle. CPHA stands for clock phase &ndash; data valid at 0 degree or 180 degrees.</p>
<h3 id="2-axi-quad-spi-ip-core">2 AXI Quad SPI IP Core</h3>
<p>When we run out of Zynq PS SPI controllers for some reason, we can turn to PL SPI IP cores, which is called AXI Quad SPI.</p>
<figure><img src="files/axi-quad-spi.png"/><figcaption>
            <h4>AXI Quad SPI IP core</h4>
        </figcaption>
</figure>

<p>In the picture, <code>io1_i</code> connects to MISO; <code>ext_spi_clk</code> and <code>s_axi_clk</code> can be connected to a same system clock. <code>ip2intc_irpt</code> can be connected to the Zynq interrupt <code>pl_ps_irq</code>.</p>
<p>You can double-click on the IP core to configure clock divider, number of slave selects, and more.</p>
<h3 id="3-bare-metal-programming">3 Bare-Metal Programming</h3>
<p>The programming sequence is as follows:</p>
<ul>
<li>First, initialize the SPI controller. Set the value of all registers to their default values.</li>
<li>Next, depending on your needs, configure the SPI controller. For example, the clock mode (CPHA and CPOL) and slave select mode (auto or manual).</li>
<li>Then, depending on the number of bytes need to be written and read, write to the DTR (Data Transmit Register) the corresponding number of bytes. Each written byte will be shifted into the TX FIFO.
<ul>
<li>Note: If the number of written bytes is <code>n_tx</code> and the number of read bytes is <code>n_rx</code>, then we should not only write <code>n_tx</code> bytes to the DTR, but also write another <code>n_rx</code> &ldquo;dummy&rdquo; bytes. This is because SPI, in nature, is a full-duplex protocol &ndash; in order to receive <code>n_rx</code> bytes, you also need to send <code>n_rx</code> bytes.</li>
</ul>
</li>
<li>Finally, read the bytes out of the DRR (Data Receive Register). When the DRR is read, the read byte will be dequed.
<ul>
<li>Note: depending on the scene, when receiving from the slave, the programmer may need to discard the first <code>n_tx</code> bytes. This is because when the master is sending data/instructions, the slave may not yet respond. Rather, the slave will not respond until the master has sent all of the bytes (instruction &amp; data). But due to the full-duplex nature of the SPI protocol, the first <code>n_tx</code> dummy bytes will also be pushed into the RX FIFO. Therefore, one may need to discard those bytes.</li>
</ul>
</li>
<li>If we use the manual slave select mode, we should assert the SS signal before the transfer and de-assert the SS signal after the transfer.</li>
</ul>
<p>The following code sends two bytes <code>[0x00 0x37]</code> to the slave and reads one byte from the slave.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;xspi.h&#34; // axi quad spi</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;xparameters.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;xstatus.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;xplatform_info.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;xil_printf.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;sleep.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SPI_DEVICE_ID       XPAR_SPI_0_DEVICE_ID
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SPI_BASEADDR		XPAR_SPI_0_BASEADDR
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">XSpi</span> <span class="n">Spi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * SPI Initialize
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">	<span class="n">XSpi_Config</span> <span class="o">*</span><span class="n">spi_config_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">spi_config_ptr</span> <span class="o">=</span> <span class="nf">XSpi_LookupConfig</span><span class="p">(</span><span class="n">SPI_DEVICE_ID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">spi_config_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">XST_DEVICE_NOT_FOUND</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">status</span> <span class="o">=</span> <span class="nf">XSpi_CfgInitialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Spi</span><span class="p">,</span> <span class="n">spi_config_ptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="n">spi_config_ptr</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">XST_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">XST_FAILURE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Start the SPI driver so that the device is enabled.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">XSpi_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Spi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Disable Global interrupt to use polled mode operation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">XSpi_IntrGlobalDisable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Spi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. Enable master mode.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. CPHA = 1, CPOL = 0
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3. Manual Slave Select
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 4. TX/RX FIFO Reset
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">control</span> <span class="o">=</span> <span class="nf">XSpi_ReadReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_CR_OFFSET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">control</span> <span class="o">|=</span>
</span></span><span class="line"><span class="cl">				<span class="n">XSP_CR_MASTER_MODE_MASK</span> <span class="o">|</span>	<span class="c1">// Master Mode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">XSP_CR_CLK_PHASE_MASK</span>	<span class="o">|</span>	<span class="c1">// Clock Phase
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">XSP_CR_MANUAL_SS_MASK</span>	<span class="o">|</span>	<span class="c1">// Manual Slave Select
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">XSP_CR_TXFIFO_RESET_MASK</span><span class="o">|</span>	<span class="c1">// TX FIFO Reset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">XSP_CR_RXFIFO_RESET_MASK</span>	<span class="c1">// RX FIFO Reset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">XSpi_WriteReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_CR_OFFSET</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// write [0x00 0x37] and then read one byte
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">XSpi_WriteReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_DTR_OFFSET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">XSpi_WriteReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_DTR_OFFSET</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">XSpi_WriteReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_DTR_OFFSET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * SPI write
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">XSpi_WriteReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_SSR_OFFSET</span><span class="p">,</span> <span class="mh">0xE</span><span class="p">);</span> <span class="c1">// slave select // 0xE: 0b1110
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// initiate a transfer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">control</span> <span class="o">=</span> <span class="nf">XSpi_ReadReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_CR_OFFSET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">control</span> <span class="o">|=</span> <span class="n">XSP_CR_ENABLE_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XSP_CR_TRANS_INHIBIT_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">XSpi_WriteReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_CR_OFFSET</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * SPI read
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// wait for the transmit FIFO to be empty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nf">XSpi_ReadReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_SR_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span>
</span></span><span class="line"><span class="cl">					<span class="n">XSP_SR_TX_EMPTY_MASK</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="n">control</span> <span class="o">=</span> <span class="nf">XSpi_ReadReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_CR_OFFSET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">control</span> <span class="o">|=</span> <span class="n">XSP_CR_TRANS_INHIBIT_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">XSpi_WriteReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_CR_OFFSET</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// read data receive register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">while</span> <span class="p">((</span><span class="nf">XSpi_ReadReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_SR_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span>
</span></span><span class="line"><span class="cl">				<span class="n">XSP_SR_RX_EMPTY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">data</span> <span class="o">=</span> <span class="nf">XSpi_ReadReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_DRR_OFFSET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// we know (in advance) that the slave will return one byte, so we know this loop will be executed three times.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// slave de-select
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">XSpi_WriteReg</span><span class="p">(</span><span class="n">SPI_BASEADDR</span><span class="p">,</span> <span class="n">XSP_SSR_OFFSET</span><span class="p">,</span> <span class="mh">0xF</span><span class="p">);</span> <span class="c1">// 0xF: 0b1111
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nf">xil_printf</span><span class="p">(</span><span class="s">&#34;MISO: 0x%x</span><span class="se">\n\r</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4-linux-programming">4 Linux Programming</h3>
<p>In order to use the AXI Quad SPI IP core in Linux, we should add a <code>spidev</code> node to the device tree, so that we could achieve SPI communication by reading from or writing to the <code>/dev/spidevx.y</code> device.</p>
<blockquote>
<p>In <code>/dev/spidevx.y</code>, <code>x</code> stands for the x-th SPI controller, and <code>y</code> stands for the y-th chip.</p>
</blockquote>
<p>The device tree is usually initialized during boot-up and is read-only. However, after the 4.14 version of the Linux kernel, we can use the &ldquo;device tree overlay&rdquo; (briefed as DTO from now on) to dynamically add incremental device trees. Below is a code snippet of DTO.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/dts-v1/;
</span></span><span class="line"><span class="cl">/plugin/;
</span></span><span class="line"><span class="cl">/ {
</span></span><span class="line"><span class="cl">    fragment@0 {
</span></span><span class="line"><span class="cl">        target = &lt;&amp;amba&gt;;
</span></span><span class="line"><span class="cl">        overlay0: __overlay__ {                       
</span></span><span class="line"><span class="cl">            axi_quad_spi_0: axi_quad_spi@80000000 {
</span></span><span class="line"><span class="cl">                ...
</span></span><span class="line"><span class="cl">                status = &#34;okay&#34;;
</span></span><span class="line"><span class="cl">                #address-cells = &lt;1&gt;;
</span></span><span class="line"><span class="cl">                #size-cells = &lt;0&gt;;
</span></span><span class="line"><span class="cl">                spidev0: spidev@0 {
</span></span><span class="line"><span class="cl">                    compatible = &#34;spidev&#34;;
</span></span><span class="line"><span class="cl">                    reg = &lt;0&gt;;
</span></span><span class="line"><span class="cl">                    spi-max-frequency = &lt;5000000&gt;;
</span></span><span class="line"><span class="cl">                };
</span></span><span class="line"><span class="cl">            };                
</span></span><span class="line"><span class="cl">        };
</span></span><span class="line"><span class="cl">    };
</span></span><span class="line"><span class="cl">};
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Some points to be noted:</p>
<ul>
<li>We should add one more line <code>/plugin/;</code> after <code>/dts-v1/;</code> to show that this is an DTO file rather than an ordinary device tree file.</li>
<li><code>target</code> stands for which node is to be modified. Here it is <code>&lt;&amp;amba&gt;</code>, and it will be extended to the phandle of the node which has the symbol <code>amba</code>. For example, if the phandle of <code>amba</code> is <code>70</code>, then <code>&lt;&amp;amba&gt;</code> virtually stands for <code>&lt;70&gt;</code>. A phandle uniquely denotes a node and is usually allocated by the device tree compiler.</li>
<li>In most cases, we should add the <code>-@</code> compiler option, which enables support for symbol. Otherwise we can only reference the nodes by their phandle, which requires de-compiling the device tree binaries.</li>
</ul>
</blockquote>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-07-01</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://example.com/spi/" data-title="HW &amp; SW design of the AXI Quad SPI IP core" data-hashtags="SPI,Embedded Systems"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://example.com/spi/" data-hashtag="SPI"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://example.com/spi/" data-title="HW &amp; SW design of the AXI Quad SPI IP core"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://example.com/spi/" data-title="HW &amp; SW design of the AXI Quad SPI IP core"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://example.com/spi/" data-title="HW &amp; SW design of the AXI Quad SPI IP core"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/spi/">SPI</a>,&nbsp;<a href="/tags/embedded-systems/">Embedded Systems</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/ui_poll/" class="prev" rel="prev" title="Polling Jupyter widget UI events in runtime"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Polling Jupyter widget UI events in runtime</a>
            <a href="/side_proj/" class="next" rel="next" title="Some fun side-projects">Some fun side-projects<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container">
            <span id="busuanzi_container_site_pv">
                Visited: <span id="busuanzi_value_site_pv"></span> times
            </span>
            &nbsp;|&nbsp;
            <span id="busuanzi_container_site_uv">
                You are the <span id="busuanzi_value_site_uv"></span> th visiter
            </span><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="../../about" target="_blank">hfwang132</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{"valine":{"appId":"VuCJPKZn7I29ZO4cGCHLM9wQ-MdYXbMMI","appKey":"dv86fnCL7DsYQl47DmJm7mHg","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"en","pageSize":10,"placeholder":"Your comment ...","recordIP":true,"serverURLs":"https://mukjinfv.api.lncldglobal.com","visitor":true}},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
